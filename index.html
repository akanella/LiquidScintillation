<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title data-translate="Liquid Scintillation">Liquid Scintillation</title>
    <script src="js/jquery.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/bootstrap.min.js"></script>
    <script src="js/translation.js"></script>
</head>

<body>
    <div class="row col-12">
        <div class="col-10">
            <b data-translate="Liquid Scintillation Activity Calculator">Liquid Scintillation Activity Calculator</b>
            <span>v. 0.45</span>
        </div>
        <div class="col-2">
            <span style="cursor:pointer" class="languages" data-lang="eng"> en </span>
            <span> | </span>
            <span style="cursor:pointer" class="languages" data-lang="fr"> fr </span>
        </div>
    </div>
    <form id="LiquidScintillation">
        <div class="row col-12">
            <div class="col-4 text-center" style="border-right:1px black solid">
                <div class="form-group col row" style="margin-top:50px">
                    <div class="col-12 ">
                        <h4 data-translate="Sample quantity">Sample quantity</h4>
                    </div>
                    <div class="form-group col">
                        <input type="number" id="sample" class="form-control" required>
                    </div>
                    <div class="form-group col">
                        <select id="sampleunit" class="form-control">
                            <option value="ml">ml</option>
                            <option value="gr">gr</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-6 offset-2" id="input-buttons" style="margin-top:50px">

                <button type="button" id="fileinput-btn" class="btn btn-primary" data-translate="Input files...">Input
                    files...</button>
                <button type="button" id="manualinput-btn" class="btn btn-secondary"
                    data-translate="Manual input">Manual input</button>

            </div>

            <div class="col-8 row text-center" style="display:none" id="fileinput-tab">
                <div class="col">
                    <div class="form-group">
                        <label for="input">Input</label>
                        <input type="file" id="fileinput" class="form-control" multiple>
                    </div>
                    <div class="form-group">
                        <label for="background">Background</label>
                        <input type="file" id="backgroundfile" class="form-control">
                    </div>
                </div>
            </div>

            <div class="col-8 row text-center" style="display:none" id="manualinput-tab">
                <div class="col-12">
                    <h4 data-translate="Sample measurment">Sample measurment</h4>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <button type="button" class="btn btn-success btn-circle" style="border-radius:40%"
                            id="addsample-btn">+</button>
                        <button type="button" class="btn btn-danger btn-circle" style="border-radius:40%"
                            id="removesample-btn">-</button>
                        <h6>&nbsp;</h6>
                    </div>
                    <div class="form-group col">
                        <label for="tSIE">tSIE</label>
                        <input type="number" id="tSIE" name="tSIE[]" class="form-control required">
                    </div>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h4 data-translate="Region A">Region A</h4>
                        <h6 data-translate="Full Range Spectrum">Full Range Spectrum</h6>
                    </div>
                    <div class="form-group col">
                        <label for="ACPM">CPM</label>
                        <input type="number" id="ACPM" name="ACPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4 data-translate="Region B">Region B</h4>
                        <h6><sup>3</sup>H</h6>
                    </div>
                    <div class="form-group col">
                        <label for="BCPM">CPM</label>
                        <input type="number" id="BCPM" name="BCPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4 data-translate="Region C">Region C</h4>
                        <h6><sup>14</sup>C</h6>
                    </div>
                    <div class="form-group col">
                        <label for="CCPM">CPM</label>
                        <input type="number" id="CCPM" name="CCPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col-12">
                    <h4 data-translate="Background">Background</h4>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h4>&nbsp;</h4>
                        <h6>&nbsp;</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndtSIE">tSIE</label>
                        <input type="number" id="bkgrndtSIE" class="form-control required">
                    </div>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h4 data-translate="Region A">Region A</h4>
                        <h6 data-translate="Full Range Spectrum">Full Range Spectrum</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndACPM">CPM</label>
                        <input type="number" id="bkgrndACPM" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4 data-translate="Region B">Region B</h4>
                        <h6><sup>3</sup>H</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndBCPM">CPM</label>
                        <input type="number" id="bkgrndBCPM" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4 data-translate="Region C">Region C</h4>
                        <h6><sup>14</sup>C</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndCCPM">CPM</label>
                        <input type="number" id="bkgrndCCPM" class="form-control required">
                    </div>
                </div>

            </div>

            <div class="row col-4 offset-4" id="calculate-buttons" style="display:none">
                <div class="row col-12">
                    <div class="col">
                        <button type="button" id="calculate" class="btn btn-success"
                            data-translate="Calculate">Calculate</button>
                    </div>
                    <div class="col">
                        <input type="reset" id="reset-btn" value="Reset" class="btn btn-danger" data-translate="Reset">
                    </div>
                    <div class="col">
                        <button type="button" id="back-btn" class="btn btn-warning" data-translate="Back">Back</button>
                    </div>
                </div>
                <div class="col-12 form-group" id="result-tab" style="display:none">
                    <label for="result" data-translate="Activity">Activity:</label>
                    <div id="result" class="alert alert-success"></div>
                </div>
            </div>
        </div>
    </form>

    <script>
        $(document).ready(function () {
            var lang = 'eng';

            function t(value) {
                switch (lang) {
                    case 'fr':
                        if (french[value]) {
                            return french[value];
                        }
                    default:
                        return value;
                }
            }

            function translate() {
                $('*[data-translate]').each(function () {
                    let translation = t($(this).data('translate'));
                    if ($(this).is("input")) {
                        $(this).val(translation);
                    } else {
                        $(this).html(translation);
                    }
                })
            }

            if (typeof (Storage) !== "undefined") {
                let storedlang = localStorage.getItem("language");
                if (storedlang) {
                    lang = storedlang;
                    translate();
                }
            }

            $('.languages').on('click', function () {
                lang = $(this).data('lang');
                translate();
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("language", lang);
                }
            })

            var inputtype = null;
            $('#manualinput-btn').on('click', function () {
                inputtype = 'manual';
                $('#input-buttons').hide();
                $('#manualinput-tab').show();
                $('#result-tab').hide();
                $('#calculate-buttons').show();
            })

            $('#reset-btn').on('click', function () {
                inputtype = 'manual';
                $('#result-tab').hide();
            })

            $('#fileinput-btn').on('click', function () {
                inputtype = 'file';
                $('#input-buttons').hide();
                $('#fileinput-tab').show();
                $('#result-tab').hide();
                $('#calculate-buttons').show();
            })

            $('#back-btn').on('click', function () {
                inputtype = null;
                $('#input-buttons').show();
                $('#manualinput-tab').hide();
                $('#fileinput-tab').hide();
                $('#result-tab').hide();
                $('#calculate-buttons').hide();
            })

            $('#addsample-btn').on('click', function () {
                $("input[name='tSIE[]']").last().after('<input type="number" name="tSIE[]" class="form-control required">');
                $("input[name='ACPM[]']").last().after('<input type="number" name="ACPM[]" class="form-control required">');
                $("input[name='BCPM[]']").last().after('<input type="number" name="BCPM[]" class="form-control required">');
                $("input[name='CCPM[]']").last().after('<input type="number" name="CCPM[]" class="form-control required">');
            })

            $('#removesample-btn').on('click', function () {
                if ($("input[name='tSIE[]']").length == 1) {
                    return false;
                }
                $("input[name='tSIE[]']").last().remove();
                $("input[name='ACPM[]']").last().remove();
                $("input[name='BCPM[]']").last().remove();
                $("input[name='CCPM[]']").last().remove();
            })

            $('#calculate').on('click', async function () {
                $('.is-invalid').removeClass('is-invalid');

                if (!$('#sample').val()) {
                    $('#sample').addClass('is-invalid');
                    alert(t('No sample quantity'));
                    return false;
                }

                //sample είναι το πεδίο με τον αριθμό
                var sample = parseFloat($('#sample').val());

                //sampleunit είναι το unit του sample
                var sampleunit = $('#sampleunit').val();
                var result = null;

                if (inputtype === 'manual') {

                    let flag = true;
                    $('#manualinput-tab .required').each(function () {
                        if (!$(this).val()) {
                            $(this).addClass('is-invalid');
                            flag = false;
                        }
                    })
                    if (!flag) {
                        alert(t('Empty field'));
                        return false;
                    }

                    //Arrays με τις τιμές του κάθε κουτιού
                    var tSIE = $("input[name='tSIE[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var ACPM = $("input[name='ACPM[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var BCPM = $("input[name='BCPM[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var CCPM = $("input[name='CCPM[]']").map(function () { return parseFloat($(this).val()); }).get();

                    var bkgrndtSIE = parseFloat($('#bkgrndtSIE').val());
                    var bkgrndACPM = parseFloat($('#bkgrndACPM').val());
                    var bkgrndBCPM = parseFloat($('#bkgrndBCPM').val());
                    var bkgrndCCPM = parseFloat($('#bkgrndCCPM').val());

                    var Bactspm = []
                    var Cactspm = []

                    //Τα 8 πεδία (αυτονόητα ονόματα)
                    console.log(tSIE, ACPM, BCPM, CCPM, bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM);

                    for (var i in tSIE) {
                        var eff = (3.2134E-08 * tSIE[i] * tSIE[i] * tSIE[i]) + (-1.1461E-04 * tSIE[i] * tSIE[i]) + (1.5223E-01 * tSIE[i]) + (-6.5804E+00)
                        var bkgrndeff = (3.2134E-08 * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE) + (-1.1461E-04 * bkgrndtSIE * bkgrndtSIE) + (1.5223E-01 * bkgrndtSIE) + (-6.5804E+00)

                        var Bact = ((BCPM[i] / 60) / (eff / 100)) / sample
                        var Cact = ((CCPM[i] / 60) / (eff / 100)) / sample

                        var bckgrndBact = ((bkgrndBCPM / 60) / (bkgrndeff / 100))
                        var bckgrndCact = ((bkgrndCCPM / 60) / (bkgrndeff / 100))

                        var Bactsp = Bact - bckgrndBact
                        var Cactsp = Cact - bckgrndCact

                        Bactspm.push(Bactsp);
                        Cactspm.push(Cactsp);
                    }

                    mean = Bactspm.reduce((a, b) => a + b) / Bactspm.length
                    std = Math.sqrt(Bactspm.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / Bactspm.length)

                    result = mean + ' &pm; ' + std;

                } else if (inputtype === 'file') {

                    var files = $('#fileinput').prop('files');
                    var background = $('#backgroundfile').prop('files');
                    if (files.length === 0) {
                        $('#fileinput').addClass('is-invalid');
                        alert('Empty File Input');
                        return false;
                    }
                    if (background.length === 0) {
                        $('#backgroundfile').addClass('is-invalid');
                        alert('Empty Background Input');
                        return false;
                    }

                    var filepromises = Array.from(files).map(data => {
                        return new Promise((resolve, reject) => {
                            let reader = new FileReader();
                            reader.onload = function () {
                                resolve(reader.result);
                            };
                            reader.onerror = function () {
                                reject(reader.error);
                            };
                            reader.readAsText(data);
                        })
                    });


                    var backgroundpromise = new Promise((resolve, reject) => {
                        let reader = new FileReader();
                        reader.onload = function () {
                            resolve(reader.result);
                        };
                        reader.onerror = function () {
                            reject(reader.error);
                        };
                        reader.readAsText(background[0]);
                    })

                    var filedata = await Promise.all(filepromises).catch(err => {
                        alert(err);
                        throw err;
                    });

                    var backgrounddata = await backgroundpromise.catch(err => {
                        alert(err);
                        throw err;
                    });

                    //filedata είναι array μέ τα data των αρχείων
                    console.log(filedata);

                    //backgrounddata είναι τα data του background file
                    console.log(backgrounddata);

                    result = 123;

                } else {
                    alert('Wat?');
                }

                $('#result').html(result + ' Bq/' + sampleunit);
                $('#result-tab').show();

            })
        })
    </script>
</body>

</html>