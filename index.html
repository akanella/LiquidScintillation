<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title>LiquidScintillation</title>
    <script src="js/jquery.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/bootstrap.min.js"></script>
    <script src="js/translation.js"></script>
</head>

<body>
    <div class="text-center">
        <img src="img/en.png" alt="English" style="width:60px;cursor:pointer" class="languages" data-lang="eng">
        <img src="img/fr.png" alt="French" style="width:60px;cursor:pointer" class="languages" data-lang="fr">
    </div>
    <form id="LiquidScintillation">
        <div class="row col-12">
            <div class="col-4 text-center" style="border-right:1px black solid">
                <div class="form-group col row" style="margin-top:50px">
                    <div class="col-12 ">
                        <h4 data-translate="Sample">Sample</h4>
                    </div>
                    <div class="form-group col">
                        <input type="number" id="sample" class="form-control" required>
                    </div>
                    <div class="form-group col">
                        <select id="sampleselect" class="form-control">
                            <option value="vol">ml</option>
                            <option value="mass">gr</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-6 offset-2" id="input-buttons" style="margin-top:50px">

                <button type="button" id="fileinput-btn" class="btn btn-primary">Input Files</button>
                <button type="button" id="manualinput-btn" class="btn btn-secondary">Manual Input</button>

            </div>

            <div class="col-8 row text-center" style="display:none" id="fileinput-tab">
                <div class="col">
                    <div class="form-group">
                        <label for="input">Input</label>
                        <input type="file" id="fileinput" class="form-control" multiple>
                    </div>
                    <div class="form-group">
                        <label for="background">Background</label>
                        <input type="file" id="backgroundfile" class="form-control">
                    </div>
                </div>
            </div>

            <div class="col-8 row text-center" style="display:none" id="manualinput-tab">
                <div class="col row">
                    <div class="col-12 ">
                        <h4>Region A</h4>
                    </div>
                    <div class="form-group col">
                        <label for="AtSIE">tSIE</label>
                        <input type="number" id="AtSIE" class="form-control required">
                    </div>
                    <div class="form-group col">
                        <label for="ACPS">CPS</label>
                        <input type="number" id="ACPS" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4>Region B</h4>
                    </div>
                    <div class="form-group col">
                        <label for="BtSIE">tSIE</label>
                        <input type="number" id="BtSIE" class="form-control required">
                    </div>
                    <div class="form-group col">
                        <label for="BCPS">CPS</label>
                        <input type="number" id="BCPS" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h4>Region C</h4>
                    </div>
                    <div class="form-group col">
                        <label for="CtSIE">tSIE</label>
                        <input type="number" id="CtSIE" class="form-control required">
                    </div>
                    <div class="form-group col">
                        <label for="CCPS">CPS</label>
                        <input type="number" id="CCPS" class="form-control required">
                    </div>
                </div>

                <div class="col-12 row">
                    <div class="col-12">
                        <h4>Background</h4>
                    </div>
                    <div class="form-group col">
                        <label for="backtSIE">tSIE</label>
                        <input type="number" id="backtSIE" class="form-control required">
                    </div>
                    <div class="form-group col">
                        <label for="backCPS">CPS</label>
                        <input type="number" id="backCPS" class="form-control required">
                    </div>
                </div>

            </div>

            <div class="row col-4 offset-4" id="calculate-buttons" style="display:none">
                <div class="row col-12">
                    <div class="col">
                        <button type="button" id="calculate" class="btn btn-success">Calculate</button>
                    </div>
                    <div class="col">
                        <input type="reset" value="Reset" class="btn btn-danger">
                    </div>
                </div>
                <div class="col-12 form-group">
                    <label for="result">Result:</label>
                    <input type="text" readonly id="result" class="form-control">
                </div>
            </div>
        </div>
    </form>

    <script>
        $(document).ready(function () {
            var lang = 'eng';

            function t(value) {
                switch (lang) {
                    case 'fr':
                        if (french[value]) {
                            return french[value];
                        }
                    default:
                        return value;
                }
            }

            function translate() {
                $('*[data-translate]').each(function () {
                    let translation = t($(this).data('translate'));
                    if ($(this).is("input")) {
                        $(this).val(translation);
                    } else {
                        $(this).html(translation);
                    }
                })
            }

            if (typeof (Storage) !== "undefined") {
                let storedlang = localStorage.getItem("language");
                if (storedlang) {
                    lang = storedlang;
                    translate();
                }
            }

            $('.languages').on('click', function () {
                lang = $(this).data('lang');
                translate();
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("language", lang);
                }
            })

            var inputtype = null;
            $('#manualinput-btn').on('click', function () {
                inputtype = 'manual';
                $('#input-buttons').hide();
                $('#manualinput-tab').show();
                $('#calculate-buttons').show();
            })

            $('#fileinput-btn').on('click', function () {
                inputtype = 'file';
                $('#input-buttons').hide();
                $('#fileinput-tab').show();
                $('#calculate-buttons').show();
            })

            $('#calculate').on('click', async function () {
                $('.is-invalid').removeClass('is-invalid');

                if (!$('#sample').val()) {
                    $('#sample').addClass('is-invalid');
                    alert(t('Empty Sample'));
                    return false;
                }

                //sample είναι το πεδίο με τον αριθμό
                var sample = parseInt($('#sample').val());

                //sampleselect είναι ο αριθμός από το dropdown
                var sampleselect = $('#sampleselect').val();
                var result = null;

                if (inputtype === 'manual') {

                    let flag = true;
                    $('#manualinput-tab .required').each(function () {
                        $(this).addClass('is-invalid');
                        if (!$(this).val()) {
                            flag = false;
                        }
                    })
                    if (!flag) {
                        alert('Empty Field');
                        return false;
                    }

                    var AtSIE = parseFloat($('#AtSIE').val());
                    var ACPS = parseFloat($('#ACPS').val());
                    var BtSIE = parseFloat($('#BtSIE').val());
                    var BCPS = parseFloat($('#BCPS').val());
                    var CtSIE = parseFloat($('#CtSIE').val());
                    var CCPS = parseFloat($('#CCPS').val());
                    var backtSIE = parseFloat($('#backtSIE').val());
                    var backCPS = parseFloat($('#backCPS').val());

                    //Τα 8 πεδία (αυτονόητα ονόματα)
                    console.log(AtSIE, ACPS, BtSIE, BCPS, CtSIE, CCPS, backtSIE, backCPS);

                    result = 321;

                } else if (inputtype === 'file') {

                    var files = $('#fileinput').prop('files');
                    var background = $('#backgroundfile').prop('files');
                    if (files.length === 0) {
                        $('#fileinput').addClass('is-invalid');
                        alert('Empty File Input');
                        return false;
                    }
                    if (background.length === 0) {
                        $('#backgroundfile').addClass('is-invalid');
                        alert('Empty Background Input');
                        return false;
                    }

                    var filepromises = Array.from(files).map(data => {
                        return new Promise((resolve, reject) => {
                            let reader = new FileReader();
                            reader.onload = function () {
                                resolve(reader.result);
                            };
                            reader.onerror = function () {
                                reject(reader.error);
                            };
                            reader.readAsText(data);
                        })
                    });


                    var backgroundpromise = new Promise((resolve, reject) => {
                        let reader = new FileReader();
                        reader.onload = function () {
                            resolve(reader.result);
                        };
                        reader.onerror = function () {
                            reject(reader.error);
                        };
                        reader.readAsText(background[0]);
                    })

                    var filedata = await Promise.all(filepromises).catch(err => {
                        alert(err);
                        throw err;
                    });

                    var backgrounddata = await backgroundpromise.catch(err => {
                        alert(err);
                        throw err;
                    });

                    //filedata είναι array μέ τα data των αρχείων
                    console.log(filedata);

                    //backgrounddata είναι τα data του background file
                    console.log(backgrounddata);

                    result = 123;

                } else {
                    alert('Wat?');
                }

                $('#result').val(result);

            })
        })
    </script>
</body>

</html>