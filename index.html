<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title data-translate="Liquid Scintillation">Liquid Scintillation</title>
    <script src="js/jquery.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/bootstrap.min.js"></script>
    <script src="js/translation.js"></script>
    <script src="js/chart.min.js"></script>
    <link rel="icon" href="vial.png" sizes="16x16" type="image/png">
</head>



<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}
</style>

<body style="padding-bottom: 90px;">
    <div class="row col-12" style="margin-bottom:30px">
        <div class="col-10">
            <b data-translate="Liquid Scintillation Activity Calculator">Liquid Scintillation Activity Calculator</b>
            <span>v. 3.1</span>
        </div>
        <div class="col-2">
            <span style="cursor:pointer" class="languages" data-lang="eng"> en </span>
            <span> | </span>
            <span style="cursor:pointer" class="languages" data-lang="fr"> fr </span>
            <span> | </span>
            <span style="cursor:pointer" class="languages" data-lang="de"> de </span>
        </div>
    </div>
    <form id="LiquidScintillation">
        <div class="row col-12">
            <div class="col-4 text-center" style="border-right:1px black solid">
                <div class="form-group col row" style="margin-top:50px">
                    <div class="col-12 ">
                        <h4 data-translate="Sample quantity">Sample quantity</h4>
                    </div>
                    <div class="form-group col">
                        <input type="number" id="sample" class="form-control" required>
                    </div>
                    <div class="form-group col">
                        <select id="sampleunit" class="form-control">
                            <option value="ml">ml</option>
                            <option value="gr">gr</option>
                        </select>
                    </div>
                </div>
                <div class="float-right" style="margin-right: 45px;">
                    <button type="button" class="btn btn-warning" id="back-btn" data-translate="Back"
                        style="display:none">Back</button>
                </div>
                <div class="form-group col row manualinput fileinput" style="margin-top:80px;display:none">
                    <div class="form-group col">
                        <span data-translate="Isotope:">Isotope:</span>
                    </div>
                    <div class="form-group col">
                        <select id="sampleisotope" class="form-control">
                            <option value="auto">Auto</option>
                            <option value="tritium">H-3</option>
                            <option value="carbon">C-14</option>
                            <option value="other" data-translate="Unknown">Unknown</option>
                        </select>
                    </div>
                </div>
				<div class="form-group col row manualinput" style="display:none">
                    <div class="form-group col">
                        <span data-translate="Measurement Time (in min):">Time:</span>
                    </div>
                    <div class="form-group col">
                        <input type="number" id="time" class="form-control" required>
                    </div>
                </div>
            </div>

            <div class="col-6 offset-2" id="input-buttons" style="margin-top:50px">

                <button type="button" id="fileinput-btn" class="btn btn-primary" data-translate="Input files">Input
                    files</button>
                <button type="button" id="manualinput-btn" class="btn btn-secondary"
                    data-translate="Manual input">Manual input</button>

            </div>

            <div class="col-8 row text-center fileinput" style="display:none">
                <div class="col">
                    <div class="form-group">
                        <label for="input" data-translate="Sample files">Sample files</label>
                        <input type="file" id="fileinput" class="form-control" multiple>
                    </div>
                    <div class="form-group">
                        <label for="background" data-translate="Background file">Background file</label>
                        <input type="file" id="backgroundfile" class="form-control">
                    </div>
                    <div class="col-12 text-right">
                        <small class="form-text text-muted" data-translate="Last efficiency calibaration:">Last efficiency calibaration:</small><small class="form-text text-muted"> 07.2021</small>
                </div>
                </div>
            </div>

            <div class="col-8 row text-center manualinput" style="display:none">
                <div class="col-12">
                    <h4 data-translate="Sample measurement">Sample measurement</h4>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <button type="button" class="btn btn-success btn-circle" style="border-radius:40%"
                            id="addsample-btn">+</button>
                        <button type="button" class="btn btn-danger btn-circle" style="border-radius:40%"
                            id="removesample-btn">-</button>
                        <h6>&nbsp;</h6>
                    </div>
                    <div class="form-group col">
                        <label for="tSIE">tSIE</label>
                        <input type="number" id="tSIE" name="tSIE[]" class="form-control required">
                    </div>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h5 data-translate="Region A">Region A</h5>
                        <h6 data-translate="Full Range Spectrum">Full Range Spectrum</h6>
                    </div>
                    <div class="form-group col">
                        <label for="ACPM">CPM</label>
                        <input type="number" id="ACPM" name="ACPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h5 data-translate="Region B">Region B</h5>
                        <h6><sup>3</sup>H</h6>
                    </div>
                    <div class="form-group col">
                        <label for="BCPM">CPM</label>
                        <input type="number" id="BCPM" name="BCPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h5 data-translate="Region C">Region C</h5>
                        <h6><sup>14</sup>C</h6>
                    </div>
                    <div class="form-group col">
                        <label for="CCPM">CPM</label>
                        <input type="number" id="CCPM" name="CCPM[]" class="form-control required">
                    </div>
                </div>

                <div class="col-12" style="margin-top:30px">
                    <h4 data-translate="Background">Background</h4>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h4>&nbsp;</h4>
                        <h6>&nbsp;</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndtSIE">tSIE</label>
                        <input type="number" id="bkgrndtSIE" class="form-control required">
                    </div>
                </div>
                <div class="col row">
                    <div class="col-12 ">
                        <h5 data-translate="Region A">Region A</h5>
                        <h6 data-translate="Full Range Spectrum">Full Range Spectrum</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndACPM">CPM</label>
                        <input type="number" id="bkgrndACPM" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h5 data-translate="Region B">Region B</h5>
                        <h6><sup>3</sup>H</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndBCPM">CPM</label>
                        <input type="number" id="bkgrndBCPM" class="form-control required">
                    </div>
                </div>

                <div class="col row">
                    <div class="col-12">
                        <h5 data-translate="Region C">Region C</h5>
                        <h6><sup>14</sup>C</h6>
                    </div>
                    <div class="form-group col">
                        <label for="bkgrndCCPM">CPM</label>
                        <input type="number" id="bkgrndCCPM" class="form-control required">
                    </div>
                </div>
                <div class="col-12 text-right">
                    <small class="form-text text-muted" data-translate="Last efficiency calibaration:">Last efficiency calibaration:</small><small class="form-text text-muted"> 07.2021</small>
                </div>

            </div>

            <div class="row col-8 offset-4" id="calculate-buttons" style="display:none; margin-top:30px">
                <div class="row col-12">
                    <div>
                        <button type="button" id="calculate" class="btn btn-success"
                            data-translate="Calculate">Calculate</button>
                    </div>
					<div class="offset-1 fileinput" style="display:none">
                        <button type="button" id="calculate-plot" class="btn btn-success"
                            data-translate="Calculate and plot">Calculate and plot</button>
                    </div>
                    <div class="offset-1">
                        <input type="reset" id="reset-btn" value="Reset" class="btn btn-danger" data-translate="Reset">
                    </div>
                </div>
                <div class="col-12 form-group" id="result-tab" style="display:none">
                    <h6>&nbsp;</h6>
                    <label class="fileinput" style="display:none" for="result" data-translate="Files Information:">Files information:</label>
                    <div id="extraResults"></div>
                    <label for="result"><br></br></label>
                    <label for="result" data-translate="Activity:">Activity:</label>
                    <div id="result" class="alert alert-success"></div>
					<div class="col-12 form-group" id="graph" style="display:none">
                        <label for="result" data-translate="Spectra:">Spectra:</label>
						<canvas id="result-graph"></canvas>
						<button type="button" class="btn btn-info change-range" data-range="4000"
								data-translate="Region A">Region A</button>
						<button type="button" class="btn btn-info change-range" data-range="40" 
						data-translate="Region B">Region B</button>
						<button type="button" class="btn btn-info change-range" data-range="360"
						data-translate="Region C">Region C</button>
					</div>
                </div>
            </div>
        </div>
    </form>

    <div class="row col-12"
        style="position:fixed; bottom:0px; text-align: left; width:100%; background:white; height: 70px">
        <div class="col-10">
            <small class="form-text text-muted"> &copy; 2021. This work is licensed under a <a rel="license"
                    href="https://creativecommons.org/publicdomain/zero/1.0/">CC0 1.0 license</a>. <br><span>Created by
                    G. Skarakis and A. Kanellakopoulos</span><br>
                Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a
                    href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></small>
        </div>
        <div class="col-2">
            <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/"><img
                    alt="Creative Commons Public Domain Dedication" style="border-width:0"
                    src="https://licensebuttons.net/l/zero/1.0/88x31.png" /></a>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            var lang = 'eng'; var myChart = null;
			
            function t(value) {
                switch (lang) {
                    case 'fr':
                        if (french[value]) {
                            return french[value];
                        }
                    case 'de':
                        if (german[value]) {
                            return german[value];
                        }
                    default:
                        return value;
                }
            }
			
			function destroyGraph(){
				if(myChart){
					$('#graph').hide();
					myChart.destroy();
					myChart = null;
				}
			}
			
			function createChart(labels, filedata = []){
				if(myChart){
					myChart.data.labels = labels;
					myChart.update();
				} else {
					$('#graph').show();
					var ctx = $('#result-graph');
					
					let datasets = filedata.map(data => {
						const randomColor = '#'+Math.floor(Math.random()*16777215).toString(16);
						return {
							label: data.label,
							data: data.data,
							borderColor: randomColor,
							backgroundColor: randomColor+"80"
						};
					});
					myChart = new Chart(ctx, {
						type: 'line',
						responsive: true,
						data: {
							labels: labels,
							datasets: datasets
						},
						plugins: {
						  legend: {
							position: 'top',
						  },
						  title: {
							display: true,
							text: t('Liquid Scintillation')
						  }
						},
						options: {
							scales: {
								y: {
									beginAtZero: true,
									grid: {
											display:false
										}
								},
								x: {
									beginAtZero: true,
									title: {display: true, text: t("Energy")+" [keV]"},
									grid: {
											display:false
										}
								}
							}
						}
					});
				}
			}

            function translate() {
                $('*[data-translate]').each(function () {
                    let translation = t($(this).data('translate'));
                    if ($(this).is("input")) {
                        $(this).val(translation);
                    } else {
                        $(this).html(translation);
                    }
                })
				$('.translatable').hide();
				$('.translatable translate-'+lang).show();
            }

            function efficiencyFactors(sampleIsotope, tSIE, ACPM, BCPM, CCPM, bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM) {

                if ((sampleIsotope == "tritium") || (sampleIsotope == "auto"  && 1.2 * BCPM > CCPM && 1.2 * CCPM > ACPM)) {
                    var aRegion = 'B'
                    var a6 = 6.94787E-18
                    var a5 = -2.43194E-14
                    var a4 = 3.30243E-11
                    var a3 = -2.14038E-08
                    var a2 = 5.86020E-06
                    var a1 = 5.43754E-04
                    var a0 = -2.01864E-02
                    CPM = BCPM
                    bkgrndCPM = bkgrndBCPM
                } else if ((sampleIsotope == "carbon") || (sampleIsotope == "auto"  && CCPM > BCPM && 1.2 * CCPM > ACPM)) {
                    var aRegion = 'C'
                    var a6 = 0.
                    var a5 = 0.
                    if (tSIE[i] < 300.) {
                        var a4 = -3.26700E-10
                        var a3 = 2.81653E-07
                        var a2 = -9.19133E-05
                        var a1 = 1.41420E-02
                        var a0 = -2.34835E-02
                    } else {
                        var a4 = -4.31025E-13
                        var a3 = 1.31962E-09
                        var a2 = -1.57309E-06
                        var a1 = 9.12555E-04
                        var a0 = 7.38102E-01 
                    }
                    CPM = CCPM
                    bkgrndCPM = bkgrndCCPM
                } else {
                    var aRegion = 'A'
                    var a6 = 0.
                    var a5 = 0.
                    var a4 = 0.
                    var a3 = 0.
                    var a2 = 0.
                    var a1 = 0.
                    var a0 = 0.5
                    CPM = ACPM
                    bkgrndCPM = bkgrndACPM
                }

                // console.log(sampleIsotope, tSIE, ACPM, BCPM, CCPM, bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM)
                // console.log(a6,a5,a4,a3,a2,a1,a0,CPM,bkgrndCPM,aRegion)

                return {
                    a6,
                    a5,
                    a4,
                    a3,
                    a2,
                    a1,
                    a0,
                    CPM,
                    bkgrndCPM,
                    aRegion
                };

            }

            function calculateEfficiency(a6, a5, a4, a3, a2, a1, a0, tSIE, bkgrndtSIE) {

                var efficiency = (a6 * tSIE * tSIE * tSIE * tSIE * tSIE * tSIE) + (a5 * tSIE * tSIE * tSIE * tSIE * tSIE) + (a4 * tSIE * tSIE * tSIE * tSIE) + (a3 * tSIE * tSIE * tSIE) + (a2 * tSIE * tSIE) + (a1 * tSIE) + (a0)
                var bkgrndEfficiency = (a6 * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE) + (a5 * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE) + (a4 * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE) + (a3 * bkgrndtSIE * bkgrndtSIE * bkgrndtSIE) + (a2 * bkgrndtSIE * bkgrndtSIE) + (a1 * bkgrndtSIE) + (a0)

                // console.log(a6, a5, a4, a3, a2, a1, a0, tSIE, bkgrndtSIE)
                // console.log(efficiency, bkgrndEfficiency)

                return {

                    efficiency,
                    bkgrndEfficiency

                };

            }

            function calculateSpecificAcitivy(sample, time, CPM, efficiency, bkgrndCPM, bkgrndEfficiency) {

                var activityVal = ((CPM / 60) / efficiency) / sample
                var activityUnc = ((Math.pow(CPM*time,0.5) / (time*60)) / efficiency) / sample

                var bckgrndActivityVal = ((bkgrndCPM / 60) / bkgrndEfficiency)
                var bckgrndActivityUnc = ((Math.pow(CPM*time,0.5) / (time*60)) / bkgrndEfficiency)

                var specificActivityVal = activityVal - bckgrndActivityVal
                var aCalculation = Math.pow(activityUnc,2) + Math.pow(bckgrndActivityUnc,2)
                var specificActivityUnc = Math.pow(aCalculation,0.5)

                // console.log(sample, time, CPM, efficiency, bkgrndCPM, bkgrndEfficiency)
                // console.log(specificActivityVal, specificActivityUnc)

                return {

                    specificActivityVal,
                    specificActivityUnc

                };

            }

            function calculateMean(valAr, uncAr) {

                if (valAr.length == 1) {

                    var meanValue = valAr[0]
                    var meanSigma = uncAr[0]

                }else{

                    var numeratorMean = 0.
                    var denominatorMean = 0.
                    var numeratorSigmaScat = 0.

                    for (var i in valAr) {
                    
                        numeratorMean += valAr[i]/Math.pow(uncAr[i],2)
                        denominatorMean += 1/Math.pow(uncAr[i],2)

                    }

                    var meanWeight = numeratorMean/denominatorMean;
                    var sigmaStatSq = 1/denominatorMean;

                    for (var i in valAr) {

                        numeratorSigmaScat += Math.pow((valAr[i]-meanWeight)/uncAr[i],2)

                    }

                    var sigmaScatSq = numeratorSigmaScat/((valAr.length-1)*denominatorMean)

                    if (sigmaStatSq>sigmaScatSq){
                        var meanWeightSigma = Math.pow(sigmaStatSq,0.5)
                    } else {
                        var meanWeightSigma = Math.pow(sigmaScatSq,0.5)
                    }

                    var meanValue = meanWeight
                    var meanSigma = meanWeightSigma

                }

                if (meanValue < 0.) {

                    meanValue = 0.

                }

                // console.log(valAr, uncAr)
                // console.log(meanValue, meanSigma)

                return {

                    meanValue,
                    meanSigma

                };

            }

            if (typeof (Storage) !== "undefined") {
                let storedlang = localStorage.getItem("language");
                if (storedlang) {
                    lang = storedlang;
                    translate();
                }
            }

            $('.languages').on('click', function () {
                lang = $(this).data('lang');
                translate();
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("language", lang);
                }
            })
			
			$('.change-range').on('click', function () {
                createChart(Array.from(Array($(this).data('range')).keys()).map(x=>x/2));
            })

            var inputtype = null;
            $('#manualinput-btn').on('click', function () {
                inputtype = 'manual';
                $('#input-buttons').hide();
                $('.manualinput').show();
                $('#result-tab').hide();
				destroyGraph();
                $('#calculate-buttons').show();
                $('#back-btn').show();
            })

            $('#reset-btn').on('click', function () {
                $('#result-tab').hide();
				destroyGraph();
            })

            $('#fileinput-btn').on('click', function () {
                inputtype = 'file';
                $('#input-buttons').hide();
                $('.fileinput').show();
                $('#result-tab').hide();
				destroyGraph();
                $('#calculate-buttons').show();
                $('#back-btn').show();
            })

            $('#back-btn').on('click', function () {
                inputtype = null;
                $('#input-buttons').show();
                $('.manualinput').hide();
                $('.fileinput').hide();
                $('#result-tab').hide();
				destroyGraph();
                $('#calculate-buttons').hide();
                $('#back-btn').hide();
            })

            $('#addsample-btn').on('click', function () {
                $("input[name='tSIE[]']").last().after('<input type="number" name="tSIE[]" class="form-control required">');
                $("input[name='ACPM[]']").last().after('<input type="number" name="ACPM[]" class="form-control required">');
                $("input[name='BCPM[]']").last().after('<input type="number" name="BCPM[]" class="form-control required">');
                $("input[name='CCPM[]']").last().after('<input type="number" name="CCPM[]" class="form-control required">');
            })

            $('#removesample-btn').on('click', function () {
                if ($("input[name='tSIE[]']").length == 1) {
                    return false;
                }
                $("input[name='tSIE[]']").last().remove();
                $("input[name='ACPM[]']").last().remove();
                $("input[name='BCPM[]']").last().remove();
                $("input[name='CCPM[]']").last().remove();
            })
			
			$('#calculate-plot').on('click', function(){
				$('#calculate').trigger('click', ['plot']);
			})

            $('#calculate').on('click', async function (event, arg1) {
                $('.is-invalid').removeClass('is-invalid');

                if (!$('#sample').val()) {
                    $('#sample').addClass('is-invalid');
                    alert(t('No sample quantity'));
                    return false;
                }

                //sample είναι το πεδίο με τον αριθμό
                var sample = parseFloat($('#sample').val());

                //sampleunit είναι το unit του sample
                var sampleunit = $('#sampleunit').val();
                destroyGraph();
                var result = null;
				var extraResults = [];

                var listActVal = []
                var listActUnc = []
                var region = []

                if (inputtype === 'manual') {
				
					if (!$('#time').val()) {
						$('#time').addClass('is-invalid');
						alert(t('No measurement time was given'));
						return false;
					}

                    var time = parseFloat($('#time').val());

                    let flag = true;
                    $('#manualinput-tab .required').each(function () {
                        if (!$(this).val()) {
                            $(this).addClass('is-invalid');
                            flag = false;
                        }
                    })
                    if (!flag) {
                        alert(t('Empty field'));
                        return false;
                    }

                    var tSIE = $("input[name='tSIE[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var ACPM = $("input[name='ACPM[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var BCPM = $("input[name='BCPM[]']").map(function () { return parseFloat($(this).val()); }).get();
                    var CCPM = $("input[name='CCPM[]']").map(function () { return parseFloat($(this).val()); }).get();

                    var bkgrndtSIE = parseFloat($('#bkgrndtSIE').val());
                    var bkgrndACPM = parseFloat($('#bkgrndACPM').val());
                    var bkgrndBCPM = parseFloat($('#bkgrndBCPM').val());
                    var bkgrndCCPM = parseFloat($('#bkgrndCCPM').val());
                    var sampleisotope = $('#sampleisotope').val();

                    for (var i in tSIE) {
                        ACPMPE = ACPM[i] / 2000
                        BCPMPE = BCPM[i] / 18.6
                        CCPMPE = CCPM[i] / 156

                        factors = efficiencyFactors(sampleisotope, tSIE[i], ACPM[i], BCPM[i], CCPM[i], bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM);

                        efficiencies = calculateEfficiency(factors.a6, factors.a5, factors.a4, factors.a3, factors.a2, factors.a1, factors.a0, tSIE[i], bkgrndtSIE)

                        activity = calculateSpecificAcitivy(sample, time, factors.CPM, efficiencies.efficiency, factors.bkgrndCPM, efficiencies.bkgrndEfficiency)

                        listActVal.push(activity.specificActivityVal);
                        listActUnc.push(activity.specificActivityUnc);
                        region.push(factors.aRegion);

                    }

                    if (region.every((val, i, arr) => val === arr[0])) {
                        if (region[0] == 'A') {
                            var isotope = t(' of an unknown isotope (upper limit)')
                        } else if (region[0] == 'B') {
                            var isotope = t(' of <sup>3</sup>H')
                        } else if (region[0] == 'C') {
                            var isotope = t(' of <sup>14</sup>C')
                        }
                    } else {
                        alert('Wat?')
                    }

                    mean = calculateMean(listActVal, listActUnc)

                    result = mean.meanValue + ' &pm; ' + mean.meanSigma;

                } else if (inputtype === 'file') {

					var datasets = [];
                    var files = $('#fileinput').prop('files');
                    var background = $('#backgroundfile').prop('files');
                    if (files.length === 0) {
                        $('#fileinput').addClass('is-invalid');
                        alert('Empty File Input');
                        return false;
                    }
                    if (background.length === 0) {
                        $('#backgroundfile').addClass('is-invalid');
                        alert('Empty Background Input');
                        return false;
                    }

                    var filepromises = Array.from(files).map(data => {
                        return new Promise((resolve, reject) => {
                            let reader = new FileReader();
                            reader.onload = function () {
                                resolve({data: reader.result, name: data.name});
                            };
                            reader.onerror = function () {
                                reject(reader.error);
                            };
                            reader.readAsText(data);
                        })
                    });


                    var backgroundpromise = new Promise((resolve, reject) => {
                        let reader = new FileReader();
                        reader.onload = function () {
                            resolve(reader.result);
                        };
                        reader.onerror = function () {
                            reject(reader.error);
                        };
                        reader.readAsText(background[0]);
                    })

                    var filedata = await Promise.all(filepromises).catch(err => {
                        alert(err);
                        throw err;
                    });

                    var backgrounddata = await backgroundpromise.catch(err => {
                        alert(err);
                        throw err;
                    });

                    //backgrounddata είναι τα data του background file
                    var aVar = backgrounddata.indexOf("TSIE=");
                    var bVar = backgrounddata.indexOf("CTime=");
                    var cVar = backgrounddata.indexOf("COUNTS");
                    var dVar = backgrounddata.indexOf("-1");
                    var bkgrndTime = parseFloat(backgrounddata.slice(bVar+6, aVar-1));
                    var bkgrndtSIE = parseFloat(backgrounddata.slice(aVar+5, aVar+11));
                    var bkgrndcts = backgrounddata.slice(cVar+8, dVar-4);
                    var bkgrndACPM = bkgrndcts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 4000).reduce((a, b) => a + b, 0)/bkgrndTime;
                    var bkgrndBCPM = bkgrndcts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 40).reduce((a, b) => a + b, 0)/bkgrndTime;
                    var bkgrndCCPM = bkgrndcts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 360).reduce((a, b) => a + b, 0)/bkgrndTime;
					
                    var sampleisotope = $('#sampleisotope').val();
					
                    for (var i in filedata) {
                        var eVar = filedata[i].data.indexOf("TSIE=");
                        var fVar = filedata[i].data.indexOf("CTime=");
                        var gVar = filedata[i].data.indexOf("COUNTS");
                        var hVar = filedata[i].data.indexOf("-1");
                        var time = parseFloat(filedata[i].data.slice(fVar+6, eVar-1));
                        var tSIE = parseFloat(filedata[i].data.slice(eVar+5, eVar+11));
                        var cts = filedata[i].data.slice(gVar+8, hVar-4);
                        var ACPM = cts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 4000).reduce((a, b) => a + b, 0)/time;
                        var BCPM = cts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 40).reduce((a, b) => a + b, 0)/time;
                        var CCPM = cts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 360).reduce((a, b) => a + b, 0)/time;
						
						datasets.push({label: filedata[i].name, data: cts.split(/\r\n|\r|\n/).map(x=>+x).slice(0, 4000)})

                        factors = efficiencyFactors(sampleisotope, tSIE, ACPM, BCPM, CCPM, bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM);

                        efficiencies = calculateEfficiency(factors.a6, factors.a5, factors.a4, factors.a3, factors.a2, factors.a1, factors.a0, tSIE, bkgrndtSIE)

                        activity = calculateSpecificAcitivy(sample, time, factors.CPM, efficiencies.efficiency, factors.bkgrndCPM, efficiencies.bkgrndEfficiency)

                        listActVal.push(activity.specificActivityVal);
                        listActUnc.push(activity.specificActivityUnc);
                        region.push(factors.aRegion);
                        extraResults.push([filedata[i].name,tSIE,ACPM, BCPM, CCPM])
                    }

                    mean = calculateMean(listActVal, listActUnc)
                    result = mean.meanValue + ' &pm; ' + mean.meanSigma;

                    extraResults.push([t('Background'), bkgrndtSIE, bkgrndACPM, bkgrndBCPM, bkgrndCCPM])
					
					if(arg1 == 'plot'){
						createChart(Array.from(Array(4000).keys()).map(x=>x/2),datasets);
					}
					
                } else {
                    alert('Wat?');
                }
	
				if(extraResults.length>0){
					let table = extraResults.reduce((html, results) => html+results.reduce((tr,result) => tr+'<td>'+result+'</td>','<tr>')+'</tr>','<table><thead><th>'+t('File')+'</th><th>'+t('tSIE')+'</th><th>'+'CPM - '+t('Region A')+'</th><th>'+'CPM - '+t('Region B')+'</th><th>'+'CPM - '+t('Region C')+'</th></thead>')+'</tbody></table>';
					$('#extraResults').html(table);
				}else{
					$('#extraResults').html('');
				}
				
                $('#result').html('a = ' + result + ' Bq/' + sampleunit + isotope);
                $('#result-tab').show();

            })
        })
    </script>
</body>

</html>